var Evaluable=function(){function b(a,c,b,g){return void 0===a?0:"number"===typeof a?a:a.eval(c,b,g)}var a=function(a,c){"number"===typeof a?(this.opr="const",this.data=a):(this.opr=a,this.data=c)},c={};a.prototype.eval=function(a,d,e){switch(this.opr){case "const":return b(this.data,a,d,e);case "ratio":return e;case "x":return a;case "y":return d;case "+":return b(this.data.a,a,d,e)+b(this.data.b,a,d,e);case "*":return b(this.data.a,a,d,e)*b(this.data.b,a,d,e);case "-":return b(this.data.a,a,d,e)-
b(this.data.b,a,d,e);case "/":return b(this.data.a,a,d,e)/b(this.data.b,a,d,e);case "noise":var g,h=1;"object"===typeof this.data?(g=b(this.data.id,a,d,e),h=b(this.data.scale,a,d,e)):g=b(this.data,a,d,e);a*=h;d*=h;c[g]||(c[g]=new SimplexNoise(Math));return 0.5*(1+c[g].noise(a,d));case "lerp":return g=b(this.data.x,a,d,e),(1-g)*b(this.data.a,a,d,e)+g*b(this.data.b,a,d,e);case "inrange":return a=b(this.data.x,a,d,e),b(this.data.a,a,d,e)<=a&&b(this.data.b,a,d,e)>a?1:0}};return a}();var Cursor=function(){return Util.extend(GameEngine.Entity,{constructor:function(){this.imgSrc="img/cursor.png"},update:function(b){this.game.input.mouse.button===GameEngine.CONST.MOUSE_LEFT&&this.game.world.set(this.game.tileRegistry.makeTile("air"),this.x/this.game.world.imgResolution,this.y/this.game.world.imgResolution)},render:function(b){this.x=this.game.input.mouse.x-Math.round(this.game.canvas.width/2-this.game.viewFocus.x);this.y=this.game.input.mouse.y-Math.round(this.game.canvas.height/
2-this.game.viewFocus.y);b.drawImage(this.img,this.x,this.y)}})}();var Extension=function(){function b(a,b){var d=new XMLHttpRequest;d.onload=b;d.open("GET",a);d.send()}var a=function(a){this.src=a};a.prototype.load=function(a,f){b(this.src,function(b){this.extension=(new Function(b.target.responseText)).call({},a,f)})};return a}();var Region=function(){var b=function(a,c,b,d,e){this.world=a;this.size=c;this.x=b;this.y=d;this.data=this.ctx=this.displayCache=void 0;this.ctxDirty=!1;e?(this.compressedDirty=!1,this.compressedData=e):(this.compressedDirty=!0,this.compressedData="");this.generate()};b.prototype.render=function(a,c,b){!this.ctxDirty&&this.displayCache||this.updateDisplayCache();a.drawImage(this.displayCache,c,b)};b.prototype.freeDisplayCache=function(){this.ctx=this.displayCache=void 0};b.prototype.updateDisplayCache=
function(){if(!this.displayCache){var a=this.world.requestDisplayCache(this);this.displayCache=a.canvas;this.ctx=a.ctx}this.ctx.clearRect(0,0,this.displayCache.width,this.displayCache.height);for(a=0;a<this.size;a++)for(var c=0;c<this.size;c++)this.world.game.tileRegistry.renderTile(this.ctx,this.get(a,c),a*this.world.imgResolution,c*this.world.imgResolution);this.ctxDirty=!1};b.prototype.generate=function(){if(this.compressedData)this.data=JSON.parse(LZString.decompressFromUTF16(this.compressedData));
else{this.data=[];for(var a=this.world.regionSize,c=0;c<this.size;c++){this.data[c]=[];for(var b=0;b<this.size;b++)this.data[c][b]=this.world.generator.tileGen(this.x*a+c,this.y*a+b)}}};b.prototype.compress=function(){this.compressedDirty&&(this.compressedDirty=!1,this.compressedData=LZString.compressToUTF16(JSON.stringify(this.data)))};b.prototype.get=function(a,c){0>a&&(a+=this.size);0>c&&(c+=this.size);return this.data[a][c]};b.prototype.set=function(a,c,b){0>c&&(c+=this.size);0>b&&(b+=this.size);
this.data[c][b]=a;this.compressedDirty=this.ctxDirty=!0};return b}();var TileGame=function(){return Util.extend(GameEngine.Game,{constructor:function(){this.keys={left:65,right:68,up:87,down:83};this.tileRegistry=new TileRegistry(this);this.world=new World(this);this.player=new Player;this.cursor=new Cursor;this.entityHandler.addEntity(new WorldRenderer(this.world));this.entityHandler.addEntity(this.cursor);this.entityHandler.addEntity(this.player)}})}();
window.addEventListener("load",function(){var b=document.getElementById("canvas");b.width=document.body.clientWidth;b.height=document.body.clientHeight;var a=new TileGame({canvas:b});a.tileRegistry.add("invalid","img/invalid.png",!1);a.tileRegistry.add("air",void 0,!1);a.tileRegistry.add("stone","img/stone.png");a.tileRegistry.add("dirt","img/dirt.png");a.tileRegistry.add("grass","img/grass.png");a.tileRegistry.requireResources();a.res.load(function(){a.start()})});var TileRegistry=function(){var b=function(a){this.game=a;this.tileDef=[];this.tileIndexes={}};b.prototype.add=function(a,c,b,d,e,g,h){this.tileIndexes[a]=this.tileDef.length;void 0===b&&(b=!0);this.tileDef.push({name:a,imgSrc:c,solid:b,data:h,create:d,update:e,active:g});return this.tileIndexes[a]};b.prototype.requireResources=function(){for(var a=0;a<this.tileDef.length;a++)this.game.res.require(this.tileDef[a].imgSrc)};b.prototype.isSolid=function(a){void 0===a&&(a="invalid");return this.tileDef["string"===
typeof a?this.tileIndexes[a]:a].solid};b.prototype.makeTile=function(a){a="string"===typeof a?this.tileIndexes[a]:a;void 0===this.tileDef[a]&&(a=this.tileIndexes.invalid);return this.tileDef[a].hasData?new World.Tile(a,this.tileDef[a].data):a};b.prototype.renderTile=function(a,c,b,d){c="string"===typeof c?this.tileIndexes[c]:c;void 0!==this.tileDef[c]&&(c=this.game.res.get(this.tileDef[c].imgSrc))&&a.drawImage(c,b,d)};return b}();var Player=function(){return Util.extend(GameEngine.Entity,{constructor:function(){this.dy=this.dx=0;this.maxDx=256;this.xAcc=16;this.xFric=this.xFricDefault=0.9;this.lrPressed=!1;this.grav=24;this.jumpSpeed=768;this.maxDy=1E3;this.y=0;this.imgSrc="img/player.png"},init:function(){for(;!this.inWall();)this.y+=this.game.world.imgResolution;for(;this.inWall();)this.y-=this.game.world.imgResolution},update:function(b){b*=0.001;var a=this.inWall(this.x,this.y+1),c=0;this.game.input.keyDown[this.game.keys.left]&&
(c-=this.xAcc);this.game.input.keyDown[this.game.keys.right]&&(c+=this.xAcc);this.dx+=c;this.dx=Math.min(this.maxDx,Math.max(-this.maxDx,this.dx));this.lrPressed&&0===c&&(this.xFric=this.adjustedFriction());this.lrPressed=0!==c;a?this.game.input.keyDown[this.game.keys.up]&&(this.dy=-this.jumpSpeed):this.dy+=this.grav;this.dy=Math.min(this.maxDy,Math.max(-this.maxDy,this.dy));if(this.inWall(this.x+this.dx*b,this.y+this.dy*b)){if(this.inWall(this.x+this.dx*b,this.y)){for(a=0;a<this.game.world.imgResolution&&
!this.inWall(this.x+Util.sign(this.dx),this.y);a++)this.x+=Util.sign(this.dx);this.dx=0}else this.x+=this.dx*b;if(this.inWall(this.x,this.y+this.dy*b)){for(a=0;a<this.game.world.imgResolution&&!this.inWall(this.x,this.y+Util.sign(this.dy));a++)this.y+=Util.sign(this.dy);this.dy=0}else this.y+=this.dy*b}else this.x+=this.dx*b,this.y+=this.dy*b;0===c&&(this.dx*=this.xFric);this.game.setView(this.x,this.y)},adjustedFriction:function(b){b=b||1/60;var a=this.game.world.imgResolution,c=this.x+this.img.width/
2+b*this.dx/(1-this.xFricDefault),a=(c-Util.sign(this.dx)*a/2)%a;if(0===c-a-(this.x+this.img.width/2))return 0.9;b=1-b*this.dx/(c-a-(this.x+this.img.width/2));return 0<b&&1>b?b:this.xFricDefault},inWall:function(b,a){var c=this.game.world.imgResolution,f=Math.floor(Math.round(b||this.x)/c),d=Math.floor(Math.round(a||this.y)/c),e=Math.floor(Math.round((b||this.x)+this.img.width-1)/c),g=Math.floor(Math.round((a||this.y)+this.img.height-1)/c),h=this.game.world,k=this.game.tileRegistry,c=k.isSolid(h.get(f,
d)),d=k.isSolid(h.get(e,d)),f=k.isSolid(h.get(f,g)),e=k.isSolid(h.get(e,g));return c||d||e||f},render:function(b){b.drawImage(this.img,Math.round(this.x),Math.round(this.y))}})}();var WorldRenderer=function(){return Util.extend(GameEngine.Entity,{constructor:function(b){this.world=b;this.skyGradStops=[{depth:Number.MIN_SAFE_INTEGER,r:0,g:0,b:0},{depth:0,r:126,g:192,b:238},{depth:5,r:63,g:63,b:63},{depth:Number.MAX_SAFE_INTEGER,r:63,g:63,b:63}]},render:function(b){for(var a=this.game.viewFocus.y/this.game.world.imgResolution,c=1,f=this.skyGradStops;a>f[c].depth;)c++;var d=(a-f[c-1].depth)/(f[c].depth-f[c-1].depth);b.save();var a=Math.round(d*f[c].r+(1-d)*f[c-1].r),e=Math.round(d*
f[c].g+(1-d)*f[c-1].g),c=Math.round(d*f[c].b+(1-d)*f[c-1].b);b.fillStyle="#"+(16777216+65536*a+256*e+c).toString(16).substring(1);b.setTransform(1,0,0,1,0,0);b.fillRect(0,0,b.canvas.width,b.canvas.height);b.restore();this.world.setFocus(this.game.viewFocus.x,this.game.viewFocus.y);this.world.render()}})}();var ExtensionLoader=function(){function b(a,b){for(var d=0;d<b.length;d++){var e=b[d];"undefined"===typeof a[e]&&(this[e]=function(){a[b[key]].apply({},arguments)})}}var a=function(){this.extensions=[]};a.prototype.add=function(a){a&&this.extensions.push(a)};a.prototype.load=function(a,f){new b(a,["add","isSolid"]);new b(f,["addGenStop"])};return a}();var TerrainGenerator=function(){var b=function(a,b){this.tileRegistry=a;this.method=b||{scale:0.05,shapes:[{start:Number.MIN_SAFE_INTEGER,eval:new Evaluable(0),types:[{start:0,tile:"air"}]},{start:-5,eval:new Evaluable("*",{a:new Evaluable("ratio"),b:new Evaluable("noise")}),types:[{start:0,tile:"air"},{start:0.1,tile:"stone"}]},{start:5,eval:new Evaluable(0),types:[{start:0,tile:"stone"}]},{start:20,eval:new Evaluable("*",{a:new Evaluable("noise",0),b:new Evaluable("lerp",{a:new Evaluable("noise",
{id:1,scale:0.3}),b:1,x:new Evaluable("ratio")})}),types:[{start:0,tile:"stone"},{start:0.36,tile:"air"},{start:0.64,tile:"stone"}]},{start:1024,eval:new Evaluable("noise"),types:[{start:0,tile:"stone"},{start:0.36,tile:"air"},{start:0.64,tile:"stone"}]}]}};b.prototype.addGenStop=function(a,b,f){for(var d=0,e=this.method.shapes;d<e.length&&a>=e[d].start;)d++;if(e[d].start===a)throw{name:"TerrainGeneratorStopCollision",message:"TerrainGenerator already has a shape definitionfor depth "+a};e.splice(d,
0,{start:a,eval:b,types:f})};b.prototype.tileGen=function(a,b){for(var f=0,d=this.method.shapes;f<d.length&&b>=d[f].start;)f++;f--;for(var e=this.method.shapes[f].eval.eval(a*this.method.scale,b*this.method.scale,void 0!==d[f+1]?(b-d[f].start)/(d[f+1].start-d[f].start):0),g=0,f=d[f].types;g<f.length&&e>=f[g].start;)g++;g--;return this.tileRegistry.makeTile(f[g].tile)};return b}();var Tile=function(){return function(b,a){this.id=b;this.data=a}}();var World=function(){var b=function(a){this.regions=[];this.game=a;this.generator=new TerrainGenerator(this.game.tileRegistry);this.regionSize=8;this.imgResolution=24;this.displayCaches=[];for(a=0;100>a;a++){var b=document.createElement("canvas");b.width=b.height=this.regionSize*this.imgResolution;this.displayCaches[a]={canvas:b,ctx:b.getContext("2d"),region:void 0}}this.setFocus(0,0)};b.prototype.requestDisplayCache=function(a){for(var b=-1,f=0,d=this.regionSize*this.imgResolution/2,e=0;e<this.displayCaches.length;e++){if(!this.displayCaches[e].region){b=
e;break}var g=this.displayCaches[e].region.x+d-this.focusX,h=this.displayCaches[e].region.y+d-this.focusY;g*g+h*h>f&&(b=e,f=g*g+h*h)}this.displayCaches[b].region&&this.displayCaches[b].region.freeDisplayCache();this.displayCaches[b].region=a;return this.displayCaches[b]};b.prototype.getRegion=function(a,b){void 0===this.regions[a]&&(this.regions[a]=[]);void 0===this.regions[a][b]&&(this.regions[a][b]=new Region(this,this.regionSize,a,b));return this.regions[a][b]};b.prototype.get=function(a,b){return this.getRegion(Math.floor(a/
this.regionSize),Math.floor(b/this.regionSize)).get(a%this.regionSize,b%this.regionSize)};b.prototype.set=function(a,b,f){b=Math.floor(b);f=Math.floor(f);this.getRegion(Math.floor(b/this.regionSize),Math.floor(f/this.regionSize)).set(a,b%this.regionSize,f%this.regionSize)};b.prototype.setFocus=function(a,b){this.focusX=a;this.focusY=b};b.prototype.render=function(){var a=this.regionSize*this.imgResolution,b=Math.floor((this.focusX-this.game.canvas.width/2)/a),f=Math.floor((this.focusY-this.game.canvas.height/
2)/a),d=Math.floor((this.focusX+this.game.canvas.width/2)/a),e=Math.floor((this.focusY+this.game.canvas.height/2)/a);for(this.game.ctx.beginPath();b<=d;b++)for(var g=f;g<=e;g++)this.getRegion(b,g).render(this.game.ctx,b*a,g*a),this.game.ctx.moveTo(b*a+a,g*a),this.game.ctx.lineTo(b*a,g*a),this.game.ctx.lineTo(b*a,g*a+a);this.game.ctx.stroke()};return b}();
